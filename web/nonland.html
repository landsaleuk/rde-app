<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Non‑land parcels (QA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <style>
    html, body, #map {height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif;}
    .panel {
      position: absolute; z-index: 5; background: rgba(255,255,255,.95);
      padding: 10px 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.1);
      font-size: 14px; line-height: 1.3;
    }
    #legend { top: 12px; left: 12px; width: 280px; }
    #layers { top: 12px; right: 12px; }
    .swatch { display: inline-block; width: 12px; height: 12px; margin-right: 6px; border-radius: 2px; vertical-align: -2px; }
    .row { display:flex; justify-content:space-between; gap: 6px; margin: 2px 0; }
    .muted { color: #666; }
    .badge { background:#eee; border-radius:6px; padding:2px 6px; font-variant-numeric: tabular-nums; }
    .title { font-weight:700; margin-bottom:6px; }
    .note { font-size:12px; color:#666; margin-top:6px;}
    .checkbox { margin: 4px 0; }
    .popup { font-size: 12px; line-height: 1.2; }
    .popup .h { font-weight:700; }
  </style>
</head>
<body>
<div id="map"></div>

<div class="panel" id="legend">
  <div class="title">Excluded parcels (QA)</div>
  <div id="counts">
    <div class="row"><span><span class="swatch" style="background:#1f78b4"></span>offshore / land &lt; 10%</span><span class="badge" id="c-offshore">–</span></div>
    <div class="row"><span><span class="swatch" style="background:#6baed6"></span>water ≥ 50%</span><span class="badge" id="c-water">–</span></div>
    <div class="row"><span><span class="swatch" style="background:#fdae6b"></span>road corridor</span><span class="badge" id="c-road">–</span></div>
    <div class="row"><span><span class="swatch" style="background:#fd8d3c"></span>rail corridor</span><span class="badge" id="c-rail">–</span></div>
    <div class="row"><span><span class="swatch" style="background:#bdbdbd"></span>long‑thin (likely highway title)</span><span class="badge" id="c-thin">–</span></div>
    <div class="row"><span class="muted">other</span><span class="badge" id="c-other">–</span></div>
    <div class="row" style="margin-top:6px;border-top:1px solid #eee;padding-top:6px;">
      <span class="h">Total excluded</span><span class="badge" id="c-total">–</span>
    </div>
  </div>
  <div class="note">Click a polygon for details.</div>
</div>

<div class="panel" id="layers">
  <div class="title">Overlays</div>
  <label class="checkbox"><input type="checkbox" id="chk-water" checked> Water</label>
  <label class="checkbox"><input type="checkbox" id="chk-rail" checked> Rail</label>
  <label class="checkbox"><input type="checkbox" id="chk-rd-nat" checked> Roads (national)</label>
  <label class="checkbox"><input type="checkbox" id="chk-rd-reg" checked> Roads (regional)</label>
  <label class="checkbox"><input type="checkbox" id="chk-rd-loc" checked> Roads (local)</label>
</div>

<script>
  // auto-detect host so this works on any box
  const HOST = location.hostname;
  const TILES = `${location.protocol}//${HOST}:7800`;
  const API   = `${location.protocol}//${HOST}:8000`;

  // Basic OSM raster basemap
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 }
      },
      layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
    },
    center: [-2.7, 52.8], // GB-ish
    zoom: 6
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');

  map.on('load', () => {
    // ---- sources ----
    map.addSource('nonland', { type: 'vector', tiles: [`${TILES}/public.nonland_parcels_map/{z}/{x}/{y}.pbf`], minzoom: 6, maxzoom: 14 });
    map.addSource('water',   { type: 'vector', tiles: [`${TILES}/public.os_water/{z}/{x}/{y}.pbf`],        minzoom: 6, maxzoom: 14 });
    map.addSource('rail',    { type: 'vector', tiles: [`${TILES}/public.os_rail/{z}/{x}/{y}.pbf`],         minzoom: 6, maxzoom: 14 });
    map.addSource('rd_nat',  { type: 'vector', tiles: [`${TILES}/public.os_roads_national/{z}/{x}/{y}.pbf`], minzoom: 6, maxzoom: 14 });
    map.addSource('rd_reg',  { type: 'vector', tiles: [`${TILES}/public.os_roads_regional/{z}/{x}/{y}.pbf`], minzoom: 6, maxzoom: 14 });
    map.addSource('rd_loc',  { type: 'vector', tiles: [`${TILES}/public.os_roads_local/{z}/{x}/{y}.pbf`],    minzoom: 6, maxzoom: 14 });

    // ---- non-land polygons ----
    const L = 'public.nonland_parcels_map';
    const COLOR = [
      'match', ['get', 'nonland_reason'],
      'offshore/land<10%', '#1f78b4',
      'water>=50%',        '#6baed6',
      'road corridor',     '#fdae6b',
      'rail corridor',     '#fd8d3c',
      'long-thin',         '#bdbdbd',
      /* other */           '#cccccc'
    ];

    map.addLayer({
      id: 'nonland-fill',
      type: 'fill',
      source: 'nonland',
      'source-layer': L,
      paint: { 'fill-color': COLOR, 'fill-opacity': 0.5 }
    });
    map.addLayer({
      id: 'nonland-outline',
      type: 'line',
      source: 'nonland',
      'source-layer': L,
      paint: { 'line-color': '#333', 'line-width': 0.5, 'line-opacity': 0.6 }
    });

    // ---- overlays ----
    map.addLayer({ id: 'water-fill', type: 'fill', source: 'water', 'source-layer': 'public.os_water',
                   paint: { 'fill-color': '#73b3d8', 'fill-opacity': 0.25 } });
    map.addLayer({ id: 'rail-line',  type: 'line', source: 'rail',  'source-layer': 'public.os_rail',
                   paint: { 'line-color': '#6b6b6b', 'line-width': 1.2, 'line-opacity': 0.8 } });
    map.addLayer({ id: 'rd-nat', type: 'line', source: 'rd_nat', 'source-layer': 'public.os_roads_national',
                   paint: { 'line-color': '#c44e52', 'line-width': 2.2, 'line-opacity': 0.8 } });
    map.addLayer({ id: 'rd-reg', type: 'line', source: 'rd_reg', 'source-layer': 'public.os_roads_regional',
                   paint: { 'line-color': '#dd8452', 'line-width': 1.6, 'line-opacity': 0.8 } });
    map.addLayer({ id: 'rd-loc', type: 'line', source: 'rd_loc', 'source-layer': 'public.os_roads_local',
                   paint: { 'line-color': '#aa9c7e', 'line-width': 1.1, 'line-opacity': 0.7 } });

    // ---- toggles ----
    const toggle = (id, visible) => {
      map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');
    };
    const bindToggle = (inputId, layerId) => {
      const el = document.getElementById(inputId);
      el.addEventListener('change', () => toggle(layerId, el.checked));
      toggle(layerId, el.checked);
    };
    bindToggle('chk-water', 'water-fill');
    bindToggle('chk-rail',  'rail-line');
    bindToggle('chk-rd-nat','rd-nat');
    bindToggle('chk-rd-reg','rd-reg');
    bindToggle('chk-rd-loc','rd-loc');

    // ---- popup ----
    const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });
    map.on('mousemove', 'nonland-fill', e => {
      const f = e.features && e.features[0];
      if (!f) return popup.remove();
      const p = f.properties;
      popup.setLngLat(e.lngLat).setHTML(
        `<div class="popup">
           <div class="h">${p.nonland_reason || 'excluded'}</div>
           Parcel: ${p.parcel_id}<br>
           Acres: ${p.acres}
         </div>`).addTo(map);
    });
    map.on('mouseleave', 'nonland-fill', () => popup.remove());
  });

  // ---- counts from API ----
  fetch(`${API}/stats/nonland`)
    .then(r => r.json())
    .then(d => {
      const by = Object.fromEntries(d.by_reason.map(x => [x.reason, x.count]));
      const get = k => by[k] || 0;
      document.getElementById('c-offshore').textContent = get('offshore/land<10%').toLocaleString();
      document.getElementById('c-water').textContent    = get('water>=50%').toLocaleString();
      document.getElementById('c-road').textContent     = get('road corridor').toLocaleString();
      document.getElementById('c-rail').textContent     = get('rail corridor').toLocaleString();
      document.getElementById('c-thin').textContent     = get('long-thin').toLocaleString();
      document.getElementById('c-other').textContent    = get('other').toLocaleString();
      document.getElementById('c-total').textContent    = d.total.toLocaleString();
    })
    .catch(err => console.error('stats error', err));
</script>
</body>
</html>
