<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>RDE Cohorts</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <style>
    html,body,#map { height:100%; margin:0; }
    .legend {
      position:absolute; z-index:1; bottom:12px; left:12px;
      background:#fff; padding:8px 10px; border-radius:6px;
      font:13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow:0 1px 4px rgba(0,0,0,.15);
    }
    .legend .row{ display:flex; align-items:center; margin:3px 0; }
    .sw{ width:14px; height:14px; margin-right:6px; border-radius:3px;}
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  <div class="row"><span class="sw" style="background:#2c6d3c"></span>A_bare_land</div>
  <div class="row"><span class="sw" style="background:#c47f3d"></span>B_single_holding</div>
  <div class="row"><span class="sw" style="background:#5c4d7d"></span>C_dispersed_estate</div>
</div>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script>
const TILES_BASE = window.location.origin + '/tiles';     // already fixed earlier
const LAYER      = 'public.cohort_parcels_map';
const BASEMAP_URL = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';  // <-- add

const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      osm: {                                  // <-- add
        type: 'raster',
        tiles: [BASEMAP_URL],
        tileSize: 256,
        attribution: '© OpenStreetMap contributors'
      },
      cohorts: {
        type: 'vector',
        tiles: [`${TILES_BASE}/${LAYER}/{z}/{x}/{y}.pbf`],
        minzoom: 5, maxzoom: 22
      }
    },
    layers: [
      {                                       // <-- add this layer FIRST so it’s below
        id: 'osm-base',
        type: 'raster',
        source: 'osm',
        minzoom: 0, maxzoom: 19
      },
      {
        id: 'cohort-outline',
        type: 'line',
        source: 'cohorts',
        'source-layer': LAYER,
        paint: {
          'line-color': '#555',
          'line-width': ['interpolate', ['linear'], ['zoom'], 5, 0.2, 10, 0.6, 13, 1.2],
          'line-opacity': 0.7
        }
      },
      {
        id: 'cohort-fill',
        type: 'fill',
        source: 'cohorts',
        'source-layer': LAYER,
        paint: {
          'fill-color': ['match', ['get','cohort'],
            'A_bare_land',        '#2c6d3c',
            'B_single_holding',   '#c47f3d',
            'C_dispersed_estate', '#5c4d7d',
            '#cccccc'
          ],
          'fill-opacity': ['interpolate', ['linear'], ['zoom'], 5, 0.45, 11, 0.25, 13, 0.35]
        }
      }
    ]
  },
  center: [-2.5, 54.3],
  zoom: 5
});

map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.on('click','cohort-fill', (e) => {
  const p = e.features[0].properties;
  new maplibregl.Popup()
    .setLngLat(e.lngLat)
    .setHTML(`<b>${p.cohort}</b><br/>Parcel ${p.parcel_id}<br/>${p.acres} acres<br/>UPRNs: ${p.uprn_count} (interior ${p.uprn_interior_count})`)
    .addTo(map);
});
</script>
</body>
</html>
