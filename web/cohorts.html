<script>
const TILES_BASE = window.location.origin + '/tiles';     // already fixed earlier
const LAYER      = 'public.cohort_parcels_map';
const BASEMAP_URL = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';  // <-- add

const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      osm: {                                  // <-- add
        type: 'raster',
        tiles: [BASEMAP_URL],
        tileSize: 256,
        attribution: '© OpenStreetMap contributors'
      },
      cohorts: {
        type: 'vector',
        tiles: [`${TILES_BASE}/${LAYER}/{z}/{x}/{y}.pbf`],
        minzoom: 5, maxzoom: 22
      }
    },
    layers: [
      {                                       // <-- add this layer FIRST so it’s below
        id: 'osm-base',
        type: 'raster',
        source: 'osm',
        minzoom: 0, maxzoom: 19
      },
      {
        id: 'cohort-outline',
        type: 'line',
        source: 'cohorts',
        'source-layer': LAYER,
        paint: {
          'line-color': '#555',
          'line-width': ['interpolate', ['linear'], ['zoom'], 5, 0.2, 10, 0.6, 13, 1.2],
          'line-opacity': 0.7
        }
      },
      {
        id: 'cohort-fill',
        type: 'fill',
        source: 'cohorts',
        'source-layer': LAYER,
        paint: {
          'fill-color': ['match', ['get','cohort'],
            'A_bare_land',        '#2c6d3c',
            'B_single_holding',   '#c47f3d',
            'C_dispersed_estate', '#5c4d7d',
            '#cccccc'
          ],
          'fill-opacity': ['interpolate', ['linear'], ['zoom'], 5, 0.45, 11, 0.25, 13, 0.35]
        }
      }
    ]
  },
  center: [-2.5, 54.3],
  zoom: 5
});

map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.on('click','cohort-fill', (e) => {
  const p = e.features[0].properties;
  new maplibregl.Popup()
    .setLngLat(e.lngLat)
    .setHTML(`<b>${p.cohort}</b><br/>Parcel ${p.parcel_id}<br/>${p.acres} acres<br/>UPRNs: ${p.uprn_count} (interior ${p.uprn_interior_count})`)
    .addTo(map);
});
</script>